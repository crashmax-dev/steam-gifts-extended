// ==UserScript==
// @name        steam-gifts-extended
// @version     2.0.0
// @license     MIT
// @homepage    https://crashmax-dev.github.io/steam-gifts-extended/
// @icon        https://cdn.steamgifts.com/img/favicon.ico
// @match       https://www.steamgifts.com/*
// @grant       GM_addStyle
// @updateURL   https://crashmax-dev.github.io/steam-gifts-extended/steam-gifts-extended.meta.js
// @downloadURL https://crashmax-dev.github.io/steam-gifts-extended/steam-gifts-extended.user.js
// ==/UserScript==

(function(){"use strict";function o(e,t,...n){const a=document.createElement(e);return t instanceof Node?a.append(t):typeof t=="string"?a.append(s(t)):Array.isArray(t)?a.append(...t):(Object.assign(a,t),Object.assign(a.style,t?.style)),a.append(...n),a}function s(e){return document.createTextNode(e)}function w(){return typeof window<"u"}const h={info:"#2ecc71",debug:"#7f8c8d",warn:"#f39c12",error:"#c0392b"};function b(e,t){return[`%c${e}`,`background:${h[t]};border-radius:0.5em;color:white;font-weightbold;padding:2px 0.5em;font-family:cursive`]}const _={info:"\x1B[32m",debug:"\x1B[90m",warn:"\x1B[33m",error:"\x1B[31m"};function v(e,t){return`${_[t]}${e}\x1B[0m`}class k{#t;info;debug;warn;error;constructor(t){this.#t=t;for(const n of["info","debug","warn","error"])this[n]=(...a)=>this.print(n,...a)}print(t,...n){const a=console[t];w()?a(...b(this.#t,t),...n):a(v(this.#t,t),...n)}}const i=new k("[SteamGiftsExtended]"),l=document.querySelector(".js__logout")?.getAttribute("data-form")?.match(/xsrf_token=(.+)/)?.at(1);l||i.error("xsrf_token not found");async function x(e){return await(await fetch("/ajax.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`xsrf_token=${l}&do=${e.do}&code=${e.code}`})).json()}function S(){const e=q();for(const t of e){const n=L(t);t.links.append(n)}}function q(){const e=document.querySelectorAll("div.giveaway__row-inner-wrap"),t=[];for(let n of e){const a=n.querySelector("span[data-timestamp]");if(!a){i.warn("Giveaway timestamp not found",n);continue}const r=a.getAttribute("data-timestamp");if(r&&Date.now()>Number(r)*1e3)continue;const c=n.querySelector("a.giveaway__heading__name");if(!c){i.warn("Giveaway link not found",n);continue}const m=c.href.split("/").at(-2);if(!m){i.warn("Giveaway ID not found",n);continue}let u=null;const y=n.querySelectorAll("span.giveaway__heading__thin");for(const g of y)if(/\(([0-9]+)([P)])\)/i.test(g.textContent)){u=Number(g.textContent.replace(/\D+/g,""));break}if(u===null){i.warn("Giveaway points not found",y);continue}t.push({links:n.querySelector("div.giveaway__links"),target:n,id:m,points:u})}return t}function f(e){return e.classList.contains("is-faded")?"entry_delete":"entry_insert"}function d(e){return f(e)==="entry_delete"?[o("i",{className:"fa fa-plus-circle"}),s(" "),o("span","Remove giveaway")]:[o("i",{className:"fa fa-minus-circle"}),s(" "),o("span","Entry giveaway")]}function p(e){return f(e)+"-giveaway"}function L(e){const t=o("a",{id:p(e.target),href:"#",onclick:async n=>{n.preventDefault(),t.replaceChildren(o("i",{className:"fa fa-refresh fa-spin"}),s(" "),o("span","Please wait..."));const a=f(e.target),r=await x({do:a,code:e.id});if(r.type==="error")t.replaceChildren(o("i",{className:"error-color error-text fa fa-exclamation-circle"}),s(" "),o("span",{className:"error-color"},r.msg??"Unknown error"));else if(r.type==="success"){const c=document.querySelector("span.nav__points");if(!c){i.error("User points not found");return}c.textContent=r.points,t.replaceChildren(...d(e.target)),e.target.classList.toggle("is-faded"),t.id=p(e.target)}}},...d(e.target));return t}function A(){if(location.pathname!=="/")return;const e=document.querySelector(".page__heading__breadcrumbs");if(!e){i.warn("Breadcrumbs header not found");return}const t=o("a",{href:"#",onclick:n=>{n.preventDefault();const a=document.querySelectorAll("#entry_insert-giveaway");for(const r of a)r.click()}},o("i",{className:"fa fa-gift"}));t.setAttribute("data-ui-tooltip",JSON.stringify({rows:[{columns:[{name:"Entry in all giveaways"}]}]})),e.after(t)}function B(){const e=document.querySelectorAll('a[href^="https://store.steampowered.com/app/"][data-ui-tooltip]');for(const n of e){const a=n.href.split("/").at(-2),r=N(a);n.classList.contains("giveaway__icon")&&r.classList.add("giveaway__icon"),n.before(r)}const t=document.querySelectorAll('a[href^="https://steamcommunity.com/profiles/"][data-tooltip]');for(const n of t){const a=n.href.split("/").at(-1),r=D(a);n.after(r)}}function N(e){const t=o("a",{href:`https://steamdb.info/app/${e}/`,target:"_blank"},o("i",{className:"fa fa-fw fa-database"}));return t.setAttribute("data-ui-tooltip",JSON.stringify({rows:[{icon:[{class:"fa-database",color:"#000"}],columns:[{name:"Steam DB"}]}]})),t}function D(e){const t=o("a",{href:`https://steamdb.info/calculator/${e}/`,target:"_blank"},o("i",{className:"fa fa-fw fa-database"}));return t.setAttribute("data-tooltip","Visit SteamDB Profile"),t}function $(){const e=document.querySelector("header");if(!e){i.warn("Header not found");return}Object.assign(e.style,{height:"auto",position:"sticky",zIndex:1,top:0})}GM_addStyle(`.giveaway__links .error-color {
  color: #a95570;
}

.giveaway__links .error-text {
  text-shadow: 1px 1px 1px rgba(255, 255, 255, 0.3);
}
`),$(),B(),S(),A()})();
